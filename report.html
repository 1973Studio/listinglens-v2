<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Your Report ‚Äî Listing Lens</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800;0,9..40,900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #0e1117;
  --surface: #161b22;
  --surface-raised: #1c2129;
  --border: #2d333b;
  --text: #e6edf3;
  --text-muted: #8b949e;
  --accent: #d4a84b;
  --accent-dim: rgba(212,168,75,0.12);
  --red: #f85149;
  --red-dim: rgba(248,81,73,0.12);
  --orange: #e3923a;
  --orange-dim: rgba(227,146,58,0.12);
  --green: #3fb950;
  --green-dim: rgba(63,185,80,0.12);
  --blue: #58a6ff;
  --blue-dim: rgba(88,166,255,0.12);
  --font: 'DM Sans', system-ui, -apple-system, sans-serif;
  --mono: 'Space Mono', monospace;
}

html { font-family: var(--font); -webkit-font-smoothing: antialiased; background: var(--bg); color: var(--text); }
body { margin: 0; padding: 0; min-height: 100vh; }

/* ============================================================
   LAYOUT
   ============================================================ */
.container { max-width: 860px; margin: 0 auto; padding: 40px 24px 80px; }

/* ============================================================
   LOADING
   ============================================================ */
.report-loading { text-align: center; padding: 6rem 1rem; }
.report-loading-spinner {
  width: 48px; height: 48px; border: 3px solid var(--border);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin 0.8s linear infinite; margin: 0 auto 1.5rem;
}
@keyframes spin { to { transform: rotate(360deg); } }
.report-loading h2 { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--text); }
.report-loading-step { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.3rem; transition: all 0.3s; }
.report-loading-step.active { color: var(--accent); font-weight: 600; }
.report-loading-step.done { color: var(--text-muted); opacity: 0.5; }
.report-loading-step.done::before { content: '‚úì '; color: var(--green); }

/* ============================================================
   ERROR
   ============================================================ */
.report-error { text-align: center; padding: 6rem 1rem; display: none; }
.report-error-icon { font-size: 2.5rem; margin-bottom: 1rem; }
.report-error h2 { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--red); }
.report-error p { font-size: 0.85rem; color: var(--text-muted); line-height: 1.6; max-width: 400px; margin: 0 auto 1.5rem; }
.report-error-btn {
  display: inline-block; padding: 0.7rem 1.8rem; background: var(--surface); color: var(--text);
  font-family: var(--font); font-size: 0.85rem; font-weight: 700; border: 1px solid var(--border);
  border-radius: 8px; cursor: pointer; text-decoration: none; transition: all 0.15s;
}
.report-error-btn:hover { border-color: var(--accent); color: var(--accent); }

/* ============================================================
   REPORT ‚Äî hidden until rendered
   ============================================================ */
.report-content { display: none; }

/* HEADER */
.header { margin-bottom: 48px; }
.header-brand {
  font-family: var(--mono); font-size: 11px; letter-spacing: 3px;
  text-transform: uppercase; color: var(--accent); margin-bottom: 16px;
}
.header h1 { font-size: 28px; font-weight: 700; line-height: 1.25; margin-bottom: 8px; color: var(--text); }
.header-meta { font-size: 14px; color: var(--text-muted); }
.header-meta span { margin-right: 16px; }

/* VERDICT BANNER */
.verdict-banner {
  background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
  padding: 28px 32px; margin-bottom: 40px; display: flex; gap: 24px; align-items: flex-start;
}
.verdict-score {
  flex-shrink: 0; width: 72px; height: 72px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-family: var(--mono); font-size: 28px; font-weight: 700;
}
.verdict-score--red { background: var(--red-dim); color: var(--red); border: 2px solid var(--red); }
.verdict-score--amber { background: var(--orange-dim); color: var(--orange); border: 2px solid var(--orange); }
.verdict-score--green { background: var(--green-dim); color: var(--green); border: 2px solid var(--green); }
.verdict-icon { font-size: 28px; line-height: 1; }
.verdict-text h2 { font-size: 18px; font-weight: 600; margin-bottom: 6px; color: var(--text); }
.verdict-text p { font-size: 14px; color: var(--text-muted); line-height: 1.55; }

/* SECTION */
.section { margin-bottom: 40px; }
.section-title {
  font-family: var(--mono); font-size: 11px; letter-spacing: 2.5px;
  text-transform: uppercase; color: var(--text-muted); margin-bottom: 16px;
  padding-bottom: 8px; border-bottom: 1px solid var(--border);
}

/* ALERT CARDS */
.alert {
  border-radius: 10px; padding: 18px 20px; margin-bottom: 12px;
  border: 1px solid; display: flex; gap: 14px; align-items: flex-start;
}
.alert-icon {
  flex-shrink: 0; width: 28px; height: 28px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: 700;
}
.alert-red { background: var(--red-dim); border-color: rgba(248,81,73,0.25); }
.alert-red .alert-icon { background: rgba(248,81,73,0.2); color: var(--red); }
.alert-amber { background: var(--orange-dim); border-color: rgba(227,146,58,0.25); }
.alert-amber .alert-icon { background: rgba(227,146,58,0.2); color: var(--orange); }
.alert-green { background: var(--green-dim); border-color: rgba(63,185,80,0.25); }
.alert-green .alert-icon { background: rgba(63,185,80,0.2); color: var(--green); }
.alert-blue { background: var(--blue-dim); border-color: rgba(88,166,255,0.25); }
.alert-blue .alert-icon { background: rgba(88,166,255,0.2); color: var(--blue); }
.alert h3 { font-size: 14px; font-weight: 600; margin-bottom: 4px; color: var(--text); }
.alert p { font-size: 13px; color: var(--text-muted); line-height: 1.5; }

/* OWNER SENTIMENT */
.sentiment-card {
  background: var(--blue-dim); border: 1px solid rgba(88,166,255,0.25);
  border-radius: 10px; padding: 20px 22px;
}
.sentiment-summary { font-size: 14px; color: var(--text-muted); line-height: 1.6; font-style: italic; margin-bottom: 16px; }
.sentiment-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
@media (max-width: 600px) { .sentiment-columns { grid-template-columns: 1fr; } }
.sentiment-col h5 {
  font-family: var(--mono); font-size: 10px; letter-spacing: 1.5px;
  text-transform: uppercase; margin-bottom: 8px;
}
.sentiment-col.pros h5 { color: var(--green); }
.sentiment-col.cons h5 { color: var(--red); }
.sentiment-col ul { list-style: none; padding: 0; }
.sentiment-col li {
  font-size: 13px; color: var(--text-muted); line-height: 1.5;
  padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.04);
}
.sentiment-col li:last-child { border-bottom: none; }
.sentiment-col.pros li::before { content: 'üëç '; }
.sentiment-col.cons li::before { content: 'üëé '; }

/* COST TABLE */
.cost-table {
  width: 100%; border-collapse: separate; border-spacing: 0;
  border-radius: 10px; overflow: hidden; border: 1px solid var(--border);
}
.cost-table tr { background: var(--surface); }
.cost-table tr:nth-child(even) { background: var(--surface-raised); }
.cost-table tr.total-row { background: var(--accent-dim); font-weight: 600; }
.cost-table tr.total-row td { color: var(--accent); }
.cost-table td {
  padding: 12px 18px; font-size: 14px; color: var(--text-muted);
  border-bottom: 1px solid var(--border);
}
.cost-table tr:last-child td { border-bottom: none; }
.cost-table td:last-child {
  text-align: right; font-family: var(--mono); font-size: 13px;
  white-space: nowrap; color: var(--text);
}
.cost-table tr.total-row td:last-child { color: var(--accent); }
.tag {
  display: inline-block; font-size: 10px; padding: 2px 6px; border-radius: 4px;
  margin-left: 6px; vertical-align: middle; font-weight: 500;
  text-transform: uppercase; letter-spacing: 0.3px;
}
.tag-oneoff { background: var(--blue-dim); color: var(--blue); }
.tag-annual { background: var(--green-dim); color: var(--green); }

/* QUESTION GRID */
.question-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
@media (max-width: 600px) { .question-grid { grid-template-columns: 1fr; } }
.question-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
  padding: 14px 16px; font-size: 13px; line-height: 1.45; color: var(--text-muted);
}
.question-card strong {
  display: block; font-size: 12px; color: var(--accent); margin-bottom: 4px;
}

/* FLAT QUESTIONS (backward compat) */
.questions-flat { display: flex; flex-direction: column; gap: 6px; }
.question-flat {
  font-size: 14px; color: var(--text-muted); line-height: 1.5;
  padding: 10px 14px; background: var(--surface); border-radius: 8px;
  border: 1px solid var(--border);
}

/* CHECKLIST */
.checklist { list-style: none; }
.checklist li {
  padding: 12px 0; border-bottom: 1px solid var(--border); font-size: 14px;
  display: flex; gap: 10px; align-items: flex-start; color: var(--text-muted);
}
.checklist li:last-child { border-bottom: none; }
.check-box {
  flex-shrink: 0; width: 20px; height: 20px; border: 2px solid var(--border);
  border-radius: 4px; margin-top: 1px; cursor: pointer; display: flex;
  align-items: center; justify-content: center; transition: all 0.15s;
}
.check-box.checked { background: var(--green); border-color: var(--green); }
.check-box.checked::after { content: '‚úì'; color: var(--bg); font-size: 12px; font-weight: 700; }

/* PROSE */
.prose { font-size: 14px; color: var(--text-muted); line-height: 1.65; }
.prose strong { color: var(--text); font-weight: 600; }

/* SOURCES */
.sources-list { list-style: none; }
.sources-list li {
  font-size: 13px; padding: 6px 0; border-bottom: 1px solid var(--border); color: var(--text-muted);
}
.sources-list li:last-child { border-bottom: none; }
.sources-list a { color: var(--blue); text-decoration: none; }
.sources-list a:hover { text-decoration: underline; }

/* REPORT FOOTER */
.report-stamp {
  text-align: center; margin-top: 48px; font-size: 11px;
  color: var(--text-muted); font-family: var(--mono); letter-spacing: 1px;
}

/* ============================================================
   DELIVERY CARD
   ============================================================ */
.delivery-card {
  margin-top: 24px; background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; padding: 24px; display: none;
}
.delivery-card h3 { font-size: 15px; font-weight: 700; margin-bottom: 14px; color: var(--text); }
.delivery-actions { display: flex; flex-direction: column; gap: 8px; }
.delivery-btn {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 12px 20px; border-radius: 8px; font-family: var(--font);
  font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.15s; border: none; text-decoration: none;
}
.delivery-btn--pdf { background: var(--accent-dim); color: var(--accent); border: 1px solid rgba(212,168,75,0.3); }
.delivery-btn--pdf:hover { background: rgba(212,168,75,0.2); }
.delivery-btn--email { background: var(--surface-raised); color: var(--text-muted); border: 1px solid var(--border); }
.delivery-btn--email:hover { border-color: var(--accent); color: var(--accent); }
.delivery-email-form { display: none; margin-top: 12px; }
.delivery-email-input {
  width: 100%; padding: 10px 14px; background: var(--bg); border: 1px solid var(--border);
  border-radius: 8px; font-family: var(--font); font-size: 14px; color: var(--text);
  outline: none; transition: border-color 0.15s; margin-bottom: 8px;
}
.delivery-email-input:focus { border-color: var(--accent); }
.delivery-email-input::placeholder { color: var(--text-muted); }
.delivery-email-send {
  width: 100%; padding: 10px; background: var(--accent); color: var(--bg); border: none;
  border-radius: 8px; font-family: var(--font); font-size: 14px; font-weight: 700;
  cursor: pointer; transition: all 0.15s;
}
.delivery-email-send:hover { opacity: 0.9; }
.delivery-email-note { font-size: 12px; color: var(--text-muted); margin-top: 6px; text-align: center; }
.delivery-email-note a { color: var(--accent); text-decoration: none; }

/* DATA WARNING */
.data-warning {
  margin-top: 12px; padding: 14px 18px; background: var(--orange-dim);
  border: 1px solid rgba(227,146,58,0.25); border-radius: 10px; display: none;
}
.data-warning p { font-size: 13px; color: var(--orange); line-height: 1.5; text-align: center; }
.data-warning strong { font-weight: 700; }

/* ANOTHER REPORT */
.another-report { margin-top: 16px; text-align: center; display: none; }
.another-report a {
  display: inline-block; padding: 10px 24px; background: var(--surface);
  color: var(--text-muted); font-family: var(--font); font-size: 14px; font-weight: 600;
  border: 1px solid var(--border); border-radius: 8px; text-decoration: none; transition: all 0.15s;
}
.another-report a:hover { border-color: var(--accent); color: var(--accent); }

/* PAGE FOOTER */
.page-footer { text-align: center; padding: 24px 0 32px; margin-top: 16px; border-top: 1px solid var(--border); }
.page-footer a { font-size: 12px; color: var(--text-muted); text-decoration: none; margin: 0 8px; }
.page-footer a:hover { color: var(--accent); }

/* ============================================================
   PRINT ‚Äî clean white background
   ============================================================ */
@media print {
  :root {
    --bg: #fff; --surface: #f8f9fa; --surface-raised: #f1f3f5;
    --border: #dee2e6; --text: #212529; --text-muted: #495057;
    --accent: #b8860b; --red: #dc3545; --orange: #fd7e14;
    --green: #198754; --blue: #0d6efd;
    --red-dim: #fff5f5; --orange-dim: #fff9f0; --green-dim: #f0fff4; --blue-dim: #f0f7ff;
    --accent-dim: #fdf8f0;
  }
  body { background: white; color: #212529; }
  .report-loading, .report-error, .delivery-card, .data-warning,
  .another-report, .page-footer { display: none !important; }
  .report-content { display: block !important; }
  .container { padding: 20px; max-width: 100%; }
  .verdict-banner, .alert, .sentiment-card, .cost-table, .question-card {
    -webkit-print-color-adjust: exact; print-color-adjust: exact;
  }
  .check-box.checked { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .sources-list a { color: #0d6efd; }
}
</style>
</head>
<body>
<div class="container">

  <!-- LOADING -->
  <div class="report-loading" id="reportLoading">
    <div class="report-loading-spinner"></div>
    <h2>generating your report</h2>
    <div class="report-loading-step active" id="step1">reading your screenshots...</div>
    <div class="report-loading-step" id="step2">searching databases &amp; public records...</div>
    <div class="report-loading-step" id="step3">analysing red flags &amp; pricing...</div>
    <div class="report-loading-step" id="step4">writing your report...</div>
  </div>

  <!-- ERROR -->
  <div class="report-error" id="reportError">
    <div class="report-error-icon">‚ö†Ô∏è</div>
    <h2>something went wrong</h2>
    <p id="reportErrorMsg">We couldn't generate your report. Your payment is safe ‚Äî please try again or contact us.</p>
    <a href="mailto:help@listinglens.app" class="report-error-btn">contact us</a>
  </div>

  <!-- REPORT ‚Äî injected by JS -->
  <div class="report-content" id="reportContent"></div>

  <!-- DELIVERY -->
  <div class="delivery-card" id="deliveryCard">
    <h3>üì• Save your report</h3>
    <div class="delivery-actions">
      <button class="delivery-btn delivery-btn--pdf" id="printReport"><span>üñ®Ô∏è</span> Print / Save as PDF</button>
      <button class="delivery-btn delivery-btn--email" id="emailBtn"><span>üìß</span> Email me a copy</button>
    </div>
    <div class="delivery-email-form" id="emailForm">
      <input type="email" class="delivery-email-input" id="emailInput" placeholder="your email address">
      <button class="delivery-email-send" id="emailSend">send report</button>
      <p class="delivery-email-note">we'll send the report and delete your email. <a href="/privacy">privacy promise</a></p>
    </div>
  </div>

  <div class="data-warning" id="dataWarning">
    <p><strong>‚ö†Ô∏è Once you leave this page, your report and screenshots are permanently deleted.</strong> Download or email your report before closing this tab.</p>
  </div>

  <div class="another-report" id="anotherReport"><a href="/">‚Üê Analyse another listing</a></div>

  <div class="page-footer">
    <a href="/privacy">privacy</a>
    <a href="/terms">terms</a>
    <a href="mailto:help@listinglens.app">contact</a>
  </div>

</div>

<script>
/* ============================================================
   LISTING LENS ‚Äî REPORT PAGE v3.1 (Dark Theme)
   ============================================================ */

function cleanUrl(url) {
  if (!url) return '';
  var m = url.match(/\[([^\]]+)\]\(([^)]+)\)/);
  if (m) return m[2];
  return url.replace(/^\[|\]$/g, '').trim();
}

function formatDate() {
  var d = new Date();
  var m = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return d.getDate() + ' ' + m[d.getMonth()] + ' ' + d.getFullYear();
}

function esc(s) { var d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

function animateLoading(cb) {
  var steps = ['step1','step2','step3','step4'], delay = 800, i = 0;
  (function next() {
    if (i > 0) { document.getElementById(steps[i-1]).classList.remove('active'); document.getElementById(steps[i-1]).classList.add('done'); }
    if (i < steps.length) { document.getElementById(steps[i]).classList.add('active'); i++; setTimeout(next, delay + Math.random() * 400); }
    else setTimeout(cb, 300);
  })();
}

function alertIcon(level) {
  if (level === 'red') return '!';
  if (level === 'amber') return '‚ö°';
  if (level === 'green') return '‚úì';
  return 'i';
}

function alertClass(level) {
  if (level === 'red') return 'alert-red';
  if (level === 'amber') return 'alert-amber';
  if (level === 'green') return 'alert-green';
  return 'alert-blue';
}

function tagHtml(label) {
  var l = label.toLowerCase();
  if (l.indexOf('one-off') > -1 || l.indexOf('oneoff') > -1 || l.indexOf('ppsr') > -1 || l.indexOf('inspection') > -1 || l.indexOf('stamp') > -1)
    return '<span class="tag tag-oneoff">One-off</span>';
  if (l.indexOf('annual') > -1 || l.indexOf('/year') > -1 || l.indexOf('year') > -1 || l.indexOf('renewal') > -1 || l.indexOf('insurance') > -1 || l.indexOf('fuel') > -1 || l.indexOf('servic') > -1 || l.indexOf('ctp') > -1 || l.indexOf('green slip') > -1)
    return '<span class="tag tag-annual">Annual</span>';
  return '';
}

function renderReport(data) {
  document.getElementById('reportLoading').style.display = 'none';
  document.getElementById('reportContent').style.display = 'block';
  document.getElementById('deliveryCard').style.display = 'block';
  document.getElementById('dataWarning').style.display = 'block';
  document.getElementById('anotherReport').style.display = 'block';

  var v = data.verdict;
  var h = '';

  // HEADER
  h += '<div class="header">';
  h += '<div class="header-brand">Listing Lens ¬∑ ' + esc(data.category || 'Analysis') + '</div>';
  h += '<h1>' + esc(data.title) + '</h1>';
  h += '<div class="header-meta">';
  if (data.location) h += '<span>üìç ' + esc(data.location) + '</span>';
  if (data.price) h += '<span>üí≤ ' + esc(data.price) + '</span>';
  h += '</div></div>';

  // VERDICT BANNER
  h += '<div class="verdict-banner">';
  if (v.score) {
    h += '<div class="verdict-score verdict-score--' + v.level + '">' + v.score + '</div>';
  } else {
    h += '<div class="verdict-score verdict-score--' + v.level + '"><span class="verdict-icon">' + esc(v.icon) + '</span></div>';
  }
  h += '<div class="verdict-text"><h2>' + esc(v.heading) + '</h2>';
  h += '<p>' + esc(v.summary) + '</p></div></div>';

  // SECTIONS
  data.sections.forEach(function(s) {
    h += '<div class="section">';

    // Determine section title (strip emoji for the monospace header)
    var title = s.heading || '';
    var titleClean = title.replace(/^[\u{1F300}-\u{1FAD6}\u{2600}-\u{27BF}\u{FE00}-\u{FEFF}‚úÖ‚ö†Ô∏èüö®‚ùì‚öñÔ∏èüîóüí∞üë•]+\s*/u, '');
    h += '<div class="section-title">' + esc(titleClean) + '</div>';

    // FLAGS ‚Üí alert cards
    if (s.flags) {
      s.flags.forEach(function(f) {
        h += '<div class="alert ' + alertClass(f.level) + '">';
        h += '<div class="alert-icon">' + alertIcon(f.level) + '</div>';
        h += '<div><h3>' + esc(f.title) + '</h3>';
        h += '<p>' + esc(f.detail) + '</p></div></div>';
      });
    }

    // OWNER SENTIMENT
    if (s.ownerSentiment) {
      var o = s.ownerSentiment;
      h += '<div class="sentiment-card">';
      if (o.summary) h += '<div class="sentiment-summary">' + esc(o.summary) + '</div>';
      h += '<div class="sentiment-columns">';
      if (o.pros && o.pros.length) {
        h += '<div class="sentiment-col pros"><h5>What owners love</h5><ul>';
        o.pros.forEach(function(p) { h += '<li>' + esc(p) + '</li>'; });
        h += '</ul></div>';
      }
      if (o.cons && o.cons.length) {
        h += '<div class="sentiment-col cons"><h5>Common complaints</h5><ul>';
        o.cons.forEach(function(c) { h += '<li>' + esc(c) + '</li>'; });
        h += '</ul></div>';
      }
      h += '</div></div>';
    }

    // COSTS ‚Üí table with tags
    if (s.costs) {
      h += '<table class="cost-table">';
      s.costs.forEach(function(c) {
        var cls = c.isTotal ? ' class="total-row"' : '';
        var tag = c.isTotal ? '' : tagHtml(c.label + ' ' + c.value);
        h += '<tr' + cls + '><td>' + esc(c.label) + tag + '</td>';
        h += '<td>' + esc(c.value) + '</td></tr>';
      });
      h += '</table>';
    }

    // QUESTIONS ‚Äî grouped cards
    if (s.questions && s.questions.length) {
      if (typeof s.questions[0] === 'object') {
        h += '<div class="question-grid">';
        s.questions.forEach(function(q) {
          h += '<div class="question-card"><strong>' + esc(q.category) + '</strong>' + esc(q.text) + '</div>';
        });
        h += '</div>';
      } else {
        h += '<div class="questions-flat">';
        s.questions.forEach(function(q, i) { h += '<div class="question-flat">' + (i+1) + '. ' + esc(q) + '</div>'; });
        h += '</div>';
      }
    }

    // CHECKLIST
    if (s.checklist) {
      h += '<ul class="checklist">';
      s.checklist.forEach(function(item, i) {
        h += '<li><div class="check-box" data-check="' + i + '"></div><div>' + esc(item) + '</div></li>';
      });
      h += '</ul>';
    }

    // TEXT (rights etc)
    if (s.text) {
      h += '<div class="prose">' + esc(s.text) + '</div>';
    }

    // SOURCES
    if (s.sources) {
      h += '<ul class="sources-list">';
      s.sources.forEach(function(src) {
        var u = cleanUrl(src.url);
        if (u) {
          h += '<li><a href="' + esc(u) + '" target="_blank" rel="noopener">' + esc(src.label) + '</a></li>';
        } else {
          h += '<li>' + esc(src.label) + '</li>';
        }
      });
      h += '</ul>';
    }

    h += '</div>';
  });

  // STAMP
  h += '<div class="report-stamp">LISTING LENS ¬∑ GENERATED ' + formatDate().toUpperCase() + ' ¬∑ FOR INFORMATIONAL PURPOSES ONLY</div>';

  document.getElementById('reportContent').innerHTML = h;

  // Bind checklist
  document.querySelectorAll('.check-box').forEach(function(b) {
    b.addEventListener('click', function() { this.classList.toggle('checked'); });
  });
}

function showError(msg) {
  document.getElementById('reportLoading').style.display = 'none';
  document.getElementById('reportError').style.display = 'block';
  if (msg) document.getElementById('reportErrorMsg').textContent = msg;
}

// Email / Print handlers
document.getElementById('emailBtn').addEventListener('click', function() {
  var f = document.getElementById('emailForm');
  f.style.display = !f.style.display || f.style.display === 'none' ? 'block' : 'none';
  if (f.style.display === 'block') document.getElementById('emailInput').focus();
});
document.getElementById('emailSend').addEventListener('click', function() {
  var e = document.getElementById('emailInput').value.trim();
  if (!e || !e.includes('@')) { document.getElementById('emailInput').style.borderColor = 'var(--red)'; return; }
  var b = document.getElementById('emailSend'); b.textContent = 'sending...'; b.disabled = true;
  setTimeout(function() { b.textContent = '‚úì sent!'; b.style.background = 'var(--green)'; }, 1500);
});
document.getElementById('printReport').addEventListener('click', function() { window.print(); });

/* ============================================================
   DEMO DATA ‚Äî V3.1
   ============================================================ */
var demoData = {
  vehicle: {
    category: 'Vehicle Analysis',
    title: '2015 Jeep Wrangler Unlimited Sport Auto 4x4 MY15',
    price: '$22,500 excl. govt. charges',
    location: 'NSW ¬∑ Private Sale',
    country: 'Australia',
    verdict: { level: 'red', icon: 'üö®', heading: 'Proceed with Caution', summary: 'The price is roughly in line with market for the mileage, but there are several significant concerns. The registration is expiring February 2026, the 3.6L Pentastar at 156,000 km is entering the zone where costly rocker arm and lifter failures become likely, the vehicle falls within the Takata airbag recall range, and visible aftermarket modifications raise insurance and compliance questions. This is a private sale with limited legal protections ‚Äî thorough due diligence is essential.' },
    sections: [
      { heading: 'üö® Critical findings', flags: [
        { level: 'red', title: 'Registration Expiring This Month', detail: 'The registration expires February 2026 ‚Äî that is right now. It may already be expired or about to expire. An unregistered vehicle cannot legally be driven on public roads. Confirm the exact expiry date and whether it will still be registered when you collect it.' },
        { level: 'red', title: 'Takata Airbag Recall ‚Äî Check Required', detail: 'The 2014-2016 Jeep Wrangler JK is covered by a Takata airbag recall (PRA 2018/16702). A degraded inflator can rupture in a crash, projecting metal fragments. Verify recall completion using the registration plate at ismyairbagsafe.com.au or ask the seller for dealer proof.' },
        { level: 'red', title: '3.6L Pentastar at 156,000 km ‚Äî High-Risk for Known Engine Fault', detail: 'The 3.6L Pentastar V6 has a documented pattern of rocker arm and lifter failure from 60,000-160,000 km. This vehicle is squarely in that zone. Listen for ticking on cold start. Repair costs range $2,400-$6,500 depending on severity.' }
      ]},
      { heading: '‚ö†Ô∏è Additional concerns', flags: [
        { level: 'amber', title: 'Registration Plate Withheld ‚Äî Cannot Run PPSR', detail: 'The listing states "Check with seller" for the registration plate. Without plate or VIN, you cannot run a PPSR check for finance, write-off, or stolen flags. Request these before committing your time.' },
        { level: 'amber', title: 'Visible Aftermarket Modifications', detail: 'Photos show aftermarket alloy wheels and what appears to be an aftermarket bull bar. Ask for a full list of modifications. Undisclosed mods may void insurance claims and affect roadworthiness compliance.' },
        { level: 'amber', title: 'Additional Recalls ‚Äî Clockspring & Emissions', detail: 'Beyond Takata, 2015 JK Wranglers have been subject to recalls for a clockspring assembly fault (preventing driver airbag deployment) and an emissions PCM reprogramming recall. Confirm all have been completed.' },
        { level: 'amber', title: 'TIPM, Oil Cooler & Other Known Issues', detail: 'The 2015 JK is known for: oil cooler housing leaks, TIPM failures causing erratic electrics and fuel pump issues ($900-$1,200), brake booster failures, and parking brake design issues. A Jeep-specialist inspection is strongly recommended.' }
      ]},
      { heading: '‚úÖ Positive findings', flags: [
        { level: 'green', title: 'Price Broadly In-Market', detail: 'At $22,500, this sits within the typical private-sale range. CarsGuide values the 2015 Wrangler range from approximately $12,100 to $31,900 depending on variant and condition.' },
        { level: 'green', title: 'Seller ID Verified on Platform', detail: 'CarSales shows an "ID verified" badge. Not a substitute for PPSR and recall checks, but better than an anonymous seller.' },
        { level: 'green', title: 'Soft Top Model ‚Äî Lower Entry Point', detail: 'The soft top variant typically sits at the lower end of pricing for the Unlimited range, which aligns with the asking price.' }
      ]},
      { heading: 'üë• What owners say', ownerSentiment: {
        summary: 'JK Wrangler Unlimited 3.6L owners love the off-road ability and lifestyle factor, but commonly report trade-offs in comfort, fuel economy, and front-end wear as kilometres climb.',
        pros: ['Genuinely capable off-road with massive aftermarket support and specialist community', 'Removable roof and doors ‚Äî an ownership experience no other SUV offers', 'Pentastar 3.6L more reliable than earlier Wrangler engines when properly maintained', '4-door Unlimited holds stronger resale than the 2-door'],
        cons: ['Real-world fuel of 13-15 L/100km, worse with bigger tyres or lift kits', 'Highway noise and ride comfort noticeably worse than comparable SUVs', 'Front-end steering and suspension components wear frequently at higher km', 'Interior fit, finish, and water sealing a consistent frustration ‚Äî wind noise, leaks, rattles']
      }},
      { heading: 'üí∞ Hidden costs (NSW estimate)', costs: [
        { label: 'NSW Stamp Duty', value: '~$675' },
        { label: 'PPSR Check', value: '$2' },
        { label: 'Pre-purchase Inspection (4x4 specialist)', value: '$300 ‚Äì $600' },
        { label: 'NSW Registration Renewal', value: '$400 ‚Äì $700' },
        { label: 'CTP / Green Slip (NSW)', value: '$500 ‚Äì $900' },
        { label: 'Comprehensive Insurance', value: '$1,200 ‚Äì $2,500' },
        { label: 'Fuel (15,000 km √ó 11.7 L/100km √ó $2.00/L)', value: '~$3,510' },
        { label: 'Servicing (2 services @ $350-$500)', value: '$700 ‚Äì $1,000' },
        { label: 'Estimated first-year costs beyond purchase price', value: '$7,000 ‚Äì $10,000', isTotal: true }
      ]},
      { heading: '‚ùì Questions to ask the seller', questions: [
        { category: 'Registration & Rego Plate', text: 'What is the registration plate number? What is the exact expiry date? Will it still be registered when I collect it?' },
        { category: 'VIN & Recall Status', text: 'What is the full VIN? Have all Takata airbag and other recalls been completed? Can you provide dealer receipts?' },
        { category: 'Engine History', text: 'Has the engine ever developed a ticking noise? Have the rocker arms, lifters, or camshafts been inspected or replaced? Any oil leaks?' },
        { category: 'Modifications', text: 'What aftermarket parts have been fitted? Are the original wheels and bumper included? Were modifications done by a qualified workshop?' },
        { category: 'Service History', text: 'Do you have a complete service history? Who has been servicing it ‚Äî dealer or independent? When was the last oil change?' },
        { category: 'Ownership & Finance', text: 'How long have you owned it? How many previous owners? Is there any finance owing? Any insurance claims or accident history?' },
        { category: 'PPSR & Write-Off', text: 'Has the vehicle ever been declared a write-off? Has it been registered in another state?' },
        { category: 'Reason for Selling', text: 'Why are you selling? Are you aware of any current mechanical or electrical issues?' }
      ]},
      { heading: '‚úÖ Pre-purchase checklist', checklist: [
        'Request VIN and registration plate number before attending any inspection',
        'Run a PPSR check ($2 at ppsr.gov.au) for finance, write-off, and stolen status',
        'Check Takata airbag recall status at ismyairbagsafe.com.au',
        'Check all recalls at vehiclerecalls.gov.au using the VIN',
        'Book an independent pre-purchase inspection with a Jeep/4x4 specialist ‚Äî specifically request valve train and oil cooler inspection',
        'Cold-start the engine yourself and listen for ticking noises from either bank',
        'Verify registration status and expiry ‚Äî factor in re-registration costs if expired',
        'Inspect soft top for tears, window clarity, and zipper condition',
        'Test all electrics ‚Äî headlights, indicators, wipers, horn, fuel pump prime ‚Äî to rule out TIPM issues',
        'Confirm insurance quote with accurate modification disclosure before committing',
        'Get seller\'s key claims about condition, history, and modifications in writing (text/email)'
      ]},
      { heading: '‚öñÔ∏è Your rights (Australia/NSW)', text: 'In a private sale, the Australian Consumer Law (ACL) provides limited protections compared to buying from a business. The goods must match their description and the seller must have the legal right to sell. However, consumer guarantees regarding acceptable quality and fitness for purpose generally do not apply to private sales in the same way they apply to business sales. Your primary protections come from your own due diligence ‚Äî PPSR checks, independent inspections, and getting the seller\'s key claims in writing before payment.' },
      { heading: 'üîó Sources used in this report', sources: [
        { label: 'PPSR ‚Äî finance, write-off, stolen vehicle check ($2)', url: 'https://www.ppsr.gov.au' },
        { label: 'Is My Airbag Safe ‚Äî Takata recall check by rego plate', url: 'https://www.ismyairbagsafe.com.au' },
        { label: 'ACCC Product Safety ‚Äî Jeep Wrangler JK Takata recall (PRA 2018/16702)', url: 'https://www.productsafety.gov.au/recalls/fca-australia-pty-ltd-jeep-wrangler-jk-my2014-2016' },
        { label: 'Vehicle Recalls Australia ‚Äî check all recalls by VIN', url: 'https://www.vehiclerecalls.gov.au' },
        { label: 'Service NSW ‚Äî stamp duty calculator and rego transfer', url: 'https://www.service.nsw.gov.au' },
        { label: 'ACCC consumer rights ‚Äî Australian Consumer Law overview', url: 'https://www.accc.gov.au/consumers' },
        { label: 'CarsGuide ‚Äî 2015 Wrangler price range $12,100-$31,900', url: 'https://www.carsguide.com.au/jeep/wrangler/price/2015' }
      ]}
    ]
  }
};

/* ============================================================
   INIT
   ============================================================ */
(function() {
  var p = new URLSearchParams(window.location.search), demo = p.get('demo');
  if (demo && demoData[demo]) { animateLoading(function() { renderReport(demoData[demo]); }); return; }
  var rj = sessionStorage.getItem('listinglens_report');
  if (rj) { try { var d = JSON.parse(rj); animateLoading(function() { renderReport(d); }); sessionStorage.removeItem('listinglens_report'); } catch(e) { showError('We received your report but couldn\'t display it.'); } return; }
  var sess = p.get('session');
  if (sess) { showError('Report generation is not yet connected.'); return; }
  window.location.href = '/';
})();
</script>
</body>
</html>
