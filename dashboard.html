<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<script>if(!new URLSearchParams(window.location.search).get('token'))window.location.href='/';</script>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
<title>Listing Lens â€” Your Report</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800&display=swap" rel="stylesheet">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-cream: #FFFFFF;
  --bg-soft: #F9FAFB;
  --bg-cloud: #F1F5F9;
  --text-primary: #0F172A;
  --text-secondary: #64748B;
  --text-muted: #94A3B8;
  --teal: #10B981;
  --teal-hot: #34D399;
  --teal-light: #6EE7B7;
  --teal-pale: #D1FAE5;
  --teal-deep: #059669;
  --teal-dark: #064E3B;
  
  
  --red: #DC2626;
  --red-pale: #FEF2F2;
  --white: #fff;
  --border: #E5E7EB;
  --font: 'DM Sans', system-ui, -apple-system, sans-serif;
}

html {
  font-family: var(--font);
  -webkit-font-smoothing: antialiased;
  font-size: 14px;
  line-height: 1.5;
  background: var(--bg-cream);
}
body { margin: 0; color: var(--text-primary); min-height: 100svh; }

/* ============================================================
   TOP BAR
   ============================================================ */
.topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--border);
  background: var(--white);
}
.topbar-brand {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.topbar-icon {
  width: 32px; height: 32px;
  border-radius: 8px;
  background: var(--text-primary);
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
}
.topbar-name {
  font-size: 1.05rem;
  font-weight: 700;
  letter-spacing: 0.04em;
  color: var(--text-primary);
}
.topbar-status {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  font-size: 0.8rem;
  color: var(--teal);
  font-weight: 600;
}
.topbar-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--teal-hot);
  animation: pulse 2s ease-in-out infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

/* ============================================================
   MAIN CONTENT
   ============================================================ */
.dashboard {
  max-width: 600px;
  margin: 0 auto;
  padding: 2rem 1.5rem;
}

/* Ephemeral banner */
.ephemeral-banner {
  display: flex;
  align-items: flex-start;
  gap: 0.8rem;
  background: #FEF2F2;
  border: 1px solid #FECACA;
  border-radius: 12px;
  padding: 1rem 1.2rem;
  margin-bottom: 2rem;
}
.ephemeral-icon {
  font-size: 1.2rem;
  flex-shrink: 0;
  margin-top: 2px;
}
.ephemeral-text {
  font-size: 0.85rem;
  color: var(--text-secondary);
  line-height: 1.55;
}
.ephemeral-text strong { color: #991B1B; }

/* Welcome */
.welcome {
  margin-bottom: 2.5rem;
}
.welcome h1 {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--text-primary);
  letter-spacing: -0.02em;
  margin-bottom: 0.5rem;
}
.welcome p {
  font-size: 1rem;
  color: var(--text-secondary);
  line-height: 1.6;
}

/* Step indicator */
.steps {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 2rem;
}
.step-bar {
  flex: 1;
  height: 4px;
  border-radius: 2px;
  background: var(--bg-cloud);
  transition: background 0.3s ease;
}
.step-bar.active { background: var(--teal); }
.step-bar.complete { background: var(--teal-light); }

/* ============================================================
   COUNTRY SELECTOR
   ============================================================ */
.country-card {
  border: 1px solid var(--border);
  border-radius: 16px;
  background: var(--white);
  overflow: hidden;
  margin-bottom: 1.5rem;
  transition: all 0.2s ease;
}
.country-card.complete { border-color: var(--teal-light); }
.country-card-header {
  padding: 1.2rem 1.5rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.country-card-left {
  display: flex; align-items: center; gap: 0.8rem;
}
.country-card-number {
  width: 48px; height: 48px; border-radius: 50%;
  background: var(--bg-soft);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.3rem; font-weight: 700; color: var(--text-muted);
  flex-shrink: 0;
}
.country-card.complete .country-card-number {
  background: var(--teal-pale); color: var(--teal);
}
.country-card-title { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); }
.country-card-subtitle { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; }
.country-card-body { padding: 1.5rem; }

.country-select-wrapper {
  position: relative;
}
.country-search {
  width: 100%;
  padding: 1rem 1.2rem 1rem 3.2rem;
  border: 2px solid var(--bg-cloud);
  border-radius: 12px;
  font-family: inherit;
  font-size: 1rem;
  font-weight: 500;
  color: var(--text-primary);
  background: var(--bg-cream);
  outline: none;
  transition: all 0.2s ease;
}
.country-search:focus {
  border-color: var(--teal-light);
  background: rgba(209,250,229,0.08);
}
.country-search::placeholder { color: var(--text-muted); }
.country-flag {
  position: absolute;
  left: 1.2rem;
  top: 50%;
  transform: translateY(-50%);
  font-size: 1.3rem;
  pointer-events: none;
}
.country-results {
  position: absolute;
  top: calc(100% + 4px);
  left: 0; right: 0;
  background: var(--white);
  border: 1.5px solid var(--border);
  border-radius: 12px;
  box-shadow: 0 12px 32px rgba(0,0,0,0.1);
  max-height: 220px;
  overflow-y: auto;
  z-index: 20;
  display: none;
}
.country-results.open { display: block; }
.country-result {
  padding: 0.7rem 1.2rem;
  cursor: pointer;
  font-size: 0.95rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 0.6rem;
  transition: background 0.1s;
}
.country-result:first-child { border-radius: 12px 12px 0 0; }
.country-result:last-child { border-radius: 0 0 12px 12px; }
.country-result:hover,
.country-result.highlighted { background: var(--teal-pale); }
.country-result-flag { font-size: 1.2rem; }
.country-helper {
  margin-top: 0.8rem;
  font-size: 0.8rem;
  color: var(--text-muted);
  line-height: 1.5;
  display: flex;
  align-items: flex-start;
  gap: 0.4rem;
}
.country-helper svg {
  width: 14px; height: 14px; flex-shrink: 0; margin-top: 2px;
  stroke: var(--teal-light); fill: none; stroke-width: 2;
}

/* ============================================================
   UPLOAD CARDS
   ============================================================ */
.upload-cards {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.upload-card {
  border: 1px solid var(--border);
  border-radius: 16px;
  background: var(--white);
  overflow: hidden;
  transition: all 0.2s ease;
}
.upload-card.complete {
  border-color: var(--teal-light);
}
.upload-card.locked {
  opacity: 0.5;
  pointer-events: none;
}

.upload-card-header {
  padding: 1.2rem 1.5rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.upload-card-left {
  display: flex;
  align-items: center;
  gap: 0.8rem;
}
.upload-card-number {
  width: 48px; height: 48px;
  border-radius: 50%;
  background: var(--bg-soft);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--text-muted);
  flex-shrink: 0;
}
.upload-card.complete .upload-card-number {
  background: var(--teal-pale);
  color: var(--teal);
}
.upload-card-title {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text-primary);
}
.upload-card-subtitle {
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-top: 2px;
}
.upload-card-badge {
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  padding: 4px 10px;
  border-radius: 6px;
}
.badge-required { background: var(--teal-pale); color: var(--teal-deep); }
.badge-recommended { background: var(--amber-pale); color: #92400E; }
.badge-done { background: var(--teal-pale); color: var(--teal); }

.upload-card-body {
  padding: 1.5rem;
}

/* Drop zone inside card */
.card-drop {
  border: 2px dashed var(--teal-light);
  border-radius: 12px;
  padding: 2rem 1.5rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
  transition: all 0.2s ease;
  background: #F0FDF4;
}
.card-drop:hover {
  border-color: var(--teal);
  background: #DCFCE7;
}
.card-drop-icon {
  width: 44px; height: 44px;
  border-radius: 12px;
  background: var(--teal-pale);
  display: flex; align-items: center; justify-content: center;
  font-size: 22px;
}
.card-drop-text {
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--text-secondary);
}
.card-drop-hint {
  font-size: 0.78rem;
  color: var(--text-muted);
}

/* Uploaded preview */
.card-preview {
  display: none;
  border-radius: 12px;
  overflow: hidden;
  position: relative;
}
.card-preview img {
  width: 100%;
  height: 200px;
  object-fit: cover;
  display: block;
}
.card-preview-overlay {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  padding: 0.8rem 1rem;
  background: linear-gradient(transparent, rgba(0,0,0,0.6));
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.card-preview-name {
  color: white;
  font-size: 0.8rem;
  font-weight: 500;
}
.card-preview-change {
  color: white;
  font-size: 0.75rem;
  text-decoration: underline;
  cursor: pointer;
  background: none;
  border: none;
  font-family: inherit;
}

/* What we're looking for helper */
.card-helper {
  margin-top: 1rem;
  padding: 1rem;
  background: var(--bg-cream);
  border-radius: 10px;
  border: 1px solid var(--border);
}
.card-helper-title {
  font-size: 0.78rem;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-bottom: 0.5rem;
}
.card-helper-list {
  list-style: none;
  display: flex;
  flex-direction: column;
  gap: 0.35rem;
}
.card-helper-list li {
  font-size: 0.82rem;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.card-helper-list li::before {
  content: '';
  width: 5px; height: 5px;
  border-radius: 50%;
  background: var(--teal-light);
  flex-shrink: 0;
}

/* ============================================================
   GENERATE BUTTON
   ============================================================ */
.generate-section {
  margin-bottom: 2rem;
}
.generate-btn {
  width: 100%;
  padding: 1.1rem;
  border: none;
  border-radius: 14px;
  background: var(--teal);
  color: white;
  font-family: inherit;
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.6rem;
  transition: all 0.2s ease;
  box-shadow: 0 2px 12px rgba(16,185,129,0.25);
}
.generate-btn:hover {
  background: var(--teal-deep);
  box-shadow: 0 4px 20px rgba(16,185,129,0.35);
}
.generate-btn:disabled {
  background: var(--bg-cloud);
  color: var(--text-muted);
  cursor: not-allowed;
  box-shadow: none;
}
.generate-btn svg { width: 20px; height: 20px; fill: currentColor; }

.generate-note {
  text-align: center;
  font-size: 0.78rem;
  color: var(--text-muted);
  margin-top: 0.8rem;
}

/* ============================================================
   REPORT OUTPUT (hidden until generated)
   ============================================================ */
.report-output {
  display: none;
  margin-bottom: 2rem;
}
.report-output.visible { display: block; }

.report-output-header {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  margin-bottom: 1.5rem;
}
.report-output-header h2 {
  font-size: 1.3rem;
  font-weight: 700;
}
.report-done-badge {
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  padding: 4px 10px;
  border-radius: 6px;
  background: var(--teal-pale);
  color: var(--teal);
}

/* Reuse report styles from main site */
.report { border: 1px solid var(--border); border-radius: 16px; overflow: hidden; background: white; }
.report-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
.report-icon { width: 40px; height: 40px; border-radius: 10px; background: var(--bg-soft); display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
.report-meta h3 { font-size: 15px; font-weight: 700; margin-bottom: 2px; }
.report-meta p { font-size: 11px; color: var(--text-muted); }
.intel-block { padding: 18px 24px; border-bottom: 1px solid var(--border); }
.intel-block:last-child { border-bottom: none; }
.intel-block h4 { font-size: 13px; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
.badge { font-size: 9px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; padding: 3px 7px; border-radius: 4px; }
.badge--critical { background: var(--red-pale); color: var(--red); border: 1px solid #FECACA; }
.badge--info { background: var(--teal-pale); color: var(--teal-deep); border: 1px solid var(--teal-light); }
.intel-list { list-style: none; }
.intel-list li { font-size: 12px; line-height: 1.6; color: var(--text-secondary); padding: 6px 0; border-bottom: 1px solid var(--bg-soft); display: flex; gap: 8px; }
.intel-list li:last-child { border-bottom: none; }
.intel-list li::before { content: 'â†’'; color: var(--bg-cloud); flex-shrink: 0; }
.intel-list li strong { color: var(--text-primary); }
.report-verdict { padding: 18px 24px; background: var(--teal-pale); border-top: 1px solid var(--teal-light); font-size: 12px; font-weight: 600; color: var(--teal-deep); line-height: 1.55; }

/* Download / actions */
.report-actions {
  display: flex;
  gap: 0.8rem;
  margin-top: 1.5rem;
}
.action-btn {
  flex: 1;
  padding: 0.8rem;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--white);
  font-family: inherit;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-secondary);
  cursor: pointer;
  text-align: center;
  transition: all 0.15s ease;
}
.action-btn:hover { border-color: var(--teal-light); color: var(--teal); }
.action-btn--primary {
  background: var(--teal);
  color: white;
  border-color: var(--teal);
}
.action-btn--primary:hover { background: var(--teal-deep); }

/* Data deletion notice */
.deletion-notice {
  margin-top: 2rem;
  padding: 1rem 1.2rem;
  background: var(--red-pale);
  border: 1px solid #FECACA;
  border-radius: 10px;
  display: flex;
  align-items: flex-start;
  gap: 0.6rem;
  font-size: 0.8rem;
  color: var(--text-secondary);
  line-height: 1.5;
}
.deletion-notice strong { color: var(--red); }

/* ============================================================
   LOADING STATE
   ============================================================ */
.loading-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(250,250,247,0.92);
  backdrop-filter: blur(4px);
  z-index: 100;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 1.5rem;
}
.loading-overlay.visible { display: flex; }
.loading-spinner {
  width: 48px; height: 48px;
  border: 4px solid var(--bg-cloud);
  border-top-color: var(--teal);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--text-primary);
}
.loading-sub {
  font-size: 0.85rem;
  color: var(--text-muted);
}

/* Footer */
.dash-footer {
  padding: 1.5rem;
  text-align: center;
  font-size: 0.78rem;
  color: var(--text-muted);
  border-top: 1px solid var(--border);
}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <a href="/" class="topbar-brand" style="text-decoration:none;">
    <span class="topbar-name">LISTING LENS</span>
  </a>
  <div class="topbar-status">
    <div class="topbar-dot"></div>
    Session active
  </div>
</div>

<div class="dashboard">

  <!-- Ephemeral warning -->
  <div class="ephemeral-banner">
    <span class="ephemeral-icon">â±ï¸</span>
    <div class="ephemeral-text">
      <strong>This is your temporary workspace.</strong> 
      Everything here lives in your browser only â€” once your report is generated and downloaded, 
      all images and data are permanently deleted. Nothing is saved.
    </div>
  </div>

  <!-- Welcome -->
  <div class="welcome">
    <h1>Let's build your vehicle report.</h1>
    <p>Tell us where you are, then upload two screenshots of the same listing â€” the more we see, the more we find.</p>
  </div>

  <!-- Progress steps (4: country, img1, img2, generate) -->
  <div class="steps" id="stepBars">
    <div class="step-bar" id="step0"></div>
    
    <div class="step-bar" id="step1"></div>
    <div class="step-bar" id="step2"></div>
    <div class="step-bar" id="step3"></div>
  </div>

  <!-- COUNTRY SELECTOR -->
  <div class="country-card" id="countryCard">
    <div class="country-card-header">
      <div class="country-card-left">
        <div class="country-card-number">1</div>
        <div>
          <div class="country-card-title">Where are you?</div>
          <div class="country-card-subtitle">So we can check local recalls, laws &amp; costs</div>
        </div>
      </div>
      <span class="upload-card-badge badge-required" id="badgeCountry">Required</span>
    </div>
    <div class="country-card-body">
      <div class="country-select-wrapper">
        <span class="country-flag" id="selectedFlag">ğŸŒ</span>
        <input type="text" class="country-search" id="countrySearch" placeholder="start typing your country..." autocomplete="off">
        <div class="country-results" id="countryResults"></div>
      </div>
      <div class="country-helper">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
        <span>This helps us find region-specific recalls, consumer laws, and local market pricing.</span>
      </div>
    </div>
  </div>

  <!-- UPLOAD CARDS -->
  <div class="upload-cards">

    <!-- Card 1: The listing overview -->
    <div class="upload-card" id="card1">
      <div class="upload-card-header">
        <div class="upload-card-left">
          <div class="upload-card-number">2</div>
          <div>
            <div class="upload-card-title">The listing overview</div>
            <div class="upload-card-subtitle">The main image and price</div>
          </div>
        </div>
        <span class="upload-card-badge badge-required" id="badge1">Required</span>
      </div>
      <div class="upload-card-body">
        <div class="card-drop" id="drop1" onclick="triggerUpload(1)">
          <div class="card-drop-icon">ğŸ“¸</div>
          <span class="card-drop-text">Upload the screenshot you showed us</span>
          <span class="card-drop-hint">Tap to browse Â· the same image from before</span>
        </div>
        <div class="card-preview" id="preview1">
          <img id="img1" src="" alt="Screenshot 1">
          <div class="card-preview-overlay">
            <span class="card-preview-name" id="name1"></span>
            <button class="card-preview-change" onclick="triggerUpload(1)">Change</button>
          </div>
        </div>
        <div class="card-helper">
          <div class="card-helper-title">What we're looking for</div>
          <ul class="card-helper-list">
            <li>Main photo of the item</li>
            <li>Price or asking price</li>
            <li>Title and headline details</li>
            <li>Seller name or location</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Card 2: The details -->
    <div class="upload-card" id="card2">
      <div class="upload-card-header">
        <div class="upload-card-left">
          <div class="upload-card-number">3</div>
          <div>
            <div class="upload-card-title">The fine print</div>
            <div class="upload-card-subtitle">Scroll down and screenshot the details</div>
          </div>
        </div>
        <span class="upload-card-badge badge-recommended" id="badge2">Recommended</span>
      </div>
      <div class="upload-card-body">
        <div class="card-drop" id="drop2" onclick="triggerUpload(2)">
          <div class="card-drop-icon">ğŸ“‹</div>
          <span class="card-drop-text">Upload the second screenshot</span>
          <span class="card-drop-hint">Scroll down in the listing and capture the details</span>
        </div>
        <div class="card-preview" id="preview2">
          <img id="img2" src="" alt="Screenshot 2">
          <div class="card-preview-overlay">
            <span class="card-preview-name" id="name2"></span>
            <button class="card-preview-change" onclick="triggerUpload(2)">Change</button>
          </div>
        </div>
        <div class="card-helper">
          <div class="card-helper-title">What we're looking for</div>
          <ul class="card-helper-list">
            <li>Description text and specifications</li>
            <li>Features list or inclusions</li>
            <li>Condition notes, history, modifications</li>
            <li>Terms, fees, or fine print</li>
          </ul>
        </div>
      </div>
    </div>

  </div>

  <!-- Generate button -->
  <div class="generate-section">
    <button class="generate-btn" id="generateBtn" disabled onclick="generateReport()">
      <svg viewBox="0 0 24 24"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg>
      Generate my report
    </button>
    <p class="generate-note">Takes about 15â€“30 seconds. Both images are analysed together.</p>
  </div>

  <!-- Report output (hidden initially) -->
  <div class="report-output" id="reportOutput">
    <div class="report-output-header">
      <h2>Your Report</h2>
      <span class="report-done-badge">Complete</span>
    </div>

    <div id="reportContent">
      <!-- Report gets inserted here by JS -->
    </div>

    <div class="report-actions">
      <button class="action-btn action-btn--primary">Save as PDF</button>
      <button class="action-btn">Copy to clipboard</button>
    </div>

    <div class="deletion-notice">
      <span>ğŸ—‘ï¸</span>
      <div>
        <strong>Your data will be deleted.</strong> 
        Once you leave this page, both screenshots and your report are permanently removed. 
        Save or download your report now if you want to keep it.
      </div>
    </div>
  </div>

</div>

<!-- Loading overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text">Building your report...</div>
  <div class="loading-sub">Cross-referencing both screenshots now</div>
</div>

<!-- Footer -->
<div class="dash-footer">
  <a href="/privacy" style="color:var(--text-muted);text-decoration:none;">Privacy Policy</a> Â· 
  <a href="/terms" style="color:var(--text-muted);text-decoration:none;">Terms</a> Â· 
  Â© 2026 Listing Lens
</div>

<!-- Hidden file inputs -->
<input type="file" id="fileInput1" accept="image/*" style="display:none" onchange="handleUpload(1, this)">
<input type="file" id="fileInput2" accept="image/*" style="display:none" onchange="handleUpload(2, this)">

<script>
var uploaded = [false, false];
var countrySelected = false;
var selectedCountryName = '';
var selectedCountryCode = '';

// Country data â€” comprehensive list
var countries = [
  {code:'AU',flag:'ğŸ‡¦ğŸ‡º',name:'Australia'},{code:'NZ',flag:'ğŸ‡³ğŸ‡¿',name:'New Zealand'},
  {code:'US',flag:'ğŸ‡ºğŸ‡¸',name:'United States'},{code:'CA',flag:'ğŸ‡¨ğŸ‡¦',name:'Canada'},
  {code:'GB',flag:'ğŸ‡¬ğŸ‡§',name:'United Kingdom'},{code:'IE',flag:'ğŸ‡®ğŸ‡ª',name:'Ireland'},
  {code:'DE',flag:'ğŸ‡©ğŸ‡ª',name:'Germany'},{code:'FR',flag:'ğŸ‡«ğŸ‡·',name:'France'},
  {code:'NL',flag:'ğŸ‡³ğŸ‡±',name:'Netherlands'},{code:'BE',flag:'ğŸ‡§ğŸ‡ª',name:'Belgium'},
  {code:'IT',flag:'ğŸ‡®ğŸ‡¹',name:'Italy'},{code:'ES',flag:'ğŸ‡ªğŸ‡¸',name:'Spain'},
  {code:'PT',flag:'ğŸ‡µğŸ‡¹',name:'Portugal'},{code:'AT',flag:'ğŸ‡¦ğŸ‡¹',name:'Austria'},
  {code:'CH',flag:'ğŸ‡¨ğŸ‡­',name:'Switzerland'},{code:'SE',flag:'ğŸ‡¸ğŸ‡ª',name:'Sweden'},
  {code:'NO',flag:'ğŸ‡³ğŸ‡´',name:'Norway'},{code:'DK',flag:'ğŸ‡©ğŸ‡°',name:'Denmark'},
  {code:'FI',flag:'ğŸ‡«ğŸ‡®',name:'Finland'},{code:'PL',flag:'ğŸ‡µğŸ‡±',name:'Poland'},
  {code:'CZ',flag:'ğŸ‡¨ğŸ‡¿',name:'Czech Republic'},{code:'RO',flag:'ğŸ‡·ğŸ‡´',name:'Romania'},
  {code:'GR',flag:'ğŸ‡¬ğŸ‡·',name:'Greece'},{code:'HU',flag:'ğŸ‡­ğŸ‡º',name:'Hungary'},
  {code:'HR',flag:'ğŸ‡­ğŸ‡·',name:'Croatia'},{code:'BG',flag:'ğŸ‡§ğŸ‡¬',name:'Bulgaria'},
  {code:'RS',flag:'ğŸ‡·ğŸ‡¸',name:'Serbia'},{code:'SK',flag:'ğŸ‡¸ğŸ‡°',name:'Slovakia'},
  {code:'SI',flag:'ğŸ‡¸ğŸ‡®',name:'Slovenia'},{code:'LT',flag:'ğŸ‡±ğŸ‡¹',name:'Lithuania'},
  {code:'LV',flag:'ğŸ‡±ğŸ‡»',name:'Latvia'},{code:'EE',flag:'ğŸ‡ªğŸ‡ª',name:'Estonia'},
  {code:'SG',flag:'ğŸ‡¸ğŸ‡¬',name:'Singapore'},{code:'HK',flag:'ğŸ‡­ğŸ‡°',name:'Hong Kong'},
  {code:'JP',flag:'ğŸ‡¯ğŸ‡µ',name:'Japan'},{code:'KR',flag:'ğŸ‡°ğŸ‡·',name:'South Korea'},
  {code:'TW',flag:'ğŸ‡¹ğŸ‡¼',name:'Taiwan'},{code:'MY',flag:'ğŸ‡²ğŸ‡¾',name:'Malaysia'},
  {code:'TH',flag:'ğŸ‡¹ğŸ‡­',name:'Thailand'},{code:'PH',flag:'ğŸ‡µğŸ‡­',name:'Philippines'},
  {code:'ID',flag:'ğŸ‡®ğŸ‡©',name:'Indonesia'},{code:'VN',flag:'ğŸ‡»ğŸ‡³',name:'Vietnam'},
  {code:'IN',flag:'ğŸ‡®ğŸ‡³',name:'India'},{code:'BD',flag:'ğŸ‡§ğŸ‡©',name:'Bangladesh'},
  {code:'LK',flag:'ğŸ‡±ğŸ‡°',name:'Sri Lanka'},{code:'PK',flag:'ğŸ‡µğŸ‡°',name:'Pakistan'},
  {code:'AE',flag:'ğŸ‡¦ğŸ‡ª',name:'United Arab Emirates'},{code:'SA',flag:'ğŸ‡¸ğŸ‡¦',name:'Saudi Arabia'},
  {code:'IL',flag:'ğŸ‡®ğŸ‡±',name:'Israel'},{code:'EG',flag:'ğŸ‡ªğŸ‡¬',name:'Egypt'},
  {code:'ZA',flag:'ğŸ‡¿ğŸ‡¦',name:'South Africa'},{code:'NG',flag:'ğŸ‡³ğŸ‡¬',name:'Nigeria'},
  {code:'KE',flag:'ğŸ‡°ğŸ‡ª',name:'Kenya'},{code:'GH',flag:'ğŸ‡¬ğŸ‡­',name:'Ghana'},
  {code:'MA',flag:'ğŸ‡²ğŸ‡¦',name:'Morocco'},{code:'TN',flag:'ğŸ‡¹ğŸ‡³',name:'Tunisia'},
  {code:'MX',flag:'ğŸ‡²ğŸ‡½',name:'Mexico'},{code:'BR',flag:'ğŸ‡§ğŸ‡·',name:'Brazil'},
  {code:'AR',flag:'ğŸ‡¦ğŸ‡·',name:'Argentina'},{code:'CL',flag:'ğŸ‡¨ğŸ‡±',name:'Chile'},
  {code:'CO',flag:'ğŸ‡¨ğŸ‡´',name:'Colombia'},{code:'PE',flag:'ğŸ‡µğŸ‡ª',name:'Peru'},
  {code:'EC',flag:'ğŸ‡ªğŸ‡¨',name:'Ecuador'},{code:'UY',flag:'ğŸ‡ºğŸ‡¾',name:'Uruguay'},
  {code:'CR',flag:'ğŸ‡¨ğŸ‡·',name:'Costa Rica'},{code:'PA',flag:'ğŸ‡µğŸ‡¦',name:'Panama'},
  {code:'DO',flag:'ğŸ‡©ğŸ‡´',name:'Dominican Republic'},{code:'PR',flag:'ğŸ‡µğŸ‡·',name:'Puerto Rico'},
  {code:'JM',flag:'ğŸ‡¯ğŸ‡²',name:'Jamaica'},{code:'TT',flag:'ğŸ‡¹ğŸ‡¹',name:'Trinidad and Tobago'},
  {code:'IS',flag:'ğŸ‡®ğŸ‡¸',name:'Iceland'},{code:'LU',flag:'ğŸ‡±ğŸ‡º',name:'Luxembourg'},
  {code:'MT',flag:'ğŸ‡²ğŸ‡¹',name:'Malta'},{code:'CY',flag:'ğŸ‡¨ğŸ‡¾',name:'Cyprus'},
  {code:'QA',flag:'ğŸ‡¶ğŸ‡¦',name:'Qatar'},{code:'BH',flag:'ğŸ‡§ğŸ‡­',name:'Bahrain'},
  {code:'KW',flag:'ğŸ‡°ğŸ‡¼',name:'Kuwait'},{code:'OM',flag:'ğŸ‡´ğŸ‡²',name:'Oman'},
  {code:'JO',flag:'ğŸ‡¯ğŸ‡´',name:'Jordan'},{code:'LB',flag:'ğŸ‡±ğŸ‡§',name:'Lebanon'},
  {code:'MM',flag:'ğŸ‡²ğŸ‡²',name:'Myanmar'},{code:'KH',flag:'ğŸ‡°ğŸ‡­',name:'Cambodia'},
  {code:'LA',flag:'ğŸ‡±ğŸ‡¦',name:'Laos'},{code:'NP',flag:'ğŸ‡³ğŸ‡µ',name:'Nepal'},
  {code:'FJ',flag:'ğŸ‡«ğŸ‡¯',name:'Fiji'},{code:'PG',flag:'ğŸ‡µğŸ‡¬',name:'Papua New Guinea'},
  {code:'CN',flag:'ğŸ‡¨ğŸ‡³',name:'China'},{code:'RU',flag:'ğŸ‡·ğŸ‡º',name:'Russia'},
  {code:'TR',flag:'ğŸ‡¹ğŸ‡·',name:'Turkey'},{code:'UA',flag:'ğŸ‡ºğŸ‡¦',name:'Ukraine'}
];

// Aliases for common searches
var aliases = {
  'usa':'United States','us':'United States','america':'United States','uk':'United Kingdom',
  'england':'United Kingdom','britain':'United Kingdom','uae':'United Arab Emirates',
  'emirates':'United Arab Emirates','dubai':'United Arab Emirates','ksa':'Saudi Arabia',
  'oz':'Australia','aussie':'Australia','nz':'New Zealand','kiwi':'New Zealand',
  'deutschland':'Germany','espana':'Spain','brasil':'Brazil','nippon':'Japan',
  'holland':'Netherlands','south korea':'South Korea','rok':'South Korea',
  'czech':'Czech Republic','czechia':'Czech Republic'
};

var searchInput = document.getElementById('countrySearch');
var resultsDiv = document.getElementById('countryResults');
var highlightIndex = -1;

searchInput.addEventListener('input', function() {
  var q = this.value.trim().toLowerCase();
  highlightIndex = -1;
  if (q.length < 1) { resultsDiv.classList.remove('open'); return; }

  // Check aliases first
  var aliasMatch = aliases[q];

  var matches = countries.filter(function(c) {
    if (aliasMatch && c.name === aliasMatch) return true;
    return c.name.toLowerCase().indexOf(q) > -1 || c.code.toLowerCase() === q;
  });

  // Sort: starts-with first, then contains
  matches.sort(function(a, b) {
    var aStarts = a.name.toLowerCase().indexOf(q) === 0 ? 0 : 1;
    var bStarts = b.name.toLowerCase().indexOf(q) === 0 ? 0 : 1;
    return aStarts - bStarts || a.name.localeCompare(b.name);
  });

  if (matches.length === 0) {
    resultsDiv.innerHTML = '<div class="country-result" style="color:var(--text-muted);cursor:default;">No matches found</div>';
    resultsDiv.classList.add('open');
    return;
  }

  resultsDiv.innerHTML = matches.slice(0, 8).map(function(c, i) {
    return '<div class="country-result" data-code="' + c.code + '" data-flag="' + c.flag + '" data-name="' + c.name + '">' +
      '<span class="country-result-flag">' + c.flag + '</span>' + c.name + '</div>';
  }).join('');
  resultsDiv.classList.add('open');
});

searchInput.addEventListener('keydown', function(e) {
  var items = resultsDiv.querySelectorAll('.country-result[data-code]');
  if (!items.length) return;

  if (e.key === 'ArrowDown') {
    e.preventDefault();
    highlightIndex = Math.min(highlightIndex + 1, items.length - 1);
    updateHighlight(items);
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    highlightIndex = Math.max(highlightIndex - 1, 0);
    updateHighlight(items);
  } else if (e.key === 'Enter' && highlightIndex >= 0) {
    e.preventDefault();
    selectCountry(items[highlightIndex]);
  }
});

function updateHighlight(items) {
  items.forEach(function(el, i) {
    el.classList.toggle('highlighted', i === highlightIndex);
  });
}

resultsDiv.addEventListener('click', function(e) {
  var el = e.target.closest('.country-result[data-code]');
  if (el) selectCountry(el);
});

function selectCountry(el) {
  selectedCountryCode = el.dataset.code;
  selectedCountryName = el.dataset.name;
  var flag = el.dataset.flag;

  searchInput.value = selectedCountryName;
  document.getElementById('selectedFlag').textContent = flag;
  resultsDiv.classList.remove('open');

  countrySelected = true;
  var card = document.getElementById('countryCard');
  card.classList.add('complete');
  var badge = document.getElementById('badgeCountry');
  badge.textContent = 'Done';
  badge.className = 'upload-card-badge badge-done';
  updateProgress();
}

// Close results on outside click
document.addEventListener('click', function(e) {
  if (!e.target.closest('.country-select-wrapper')) {
    resultsDiv.classList.remove('open');
  }
});

function triggerUpload(n) {
  document.getElementById('fileInput' + n).click();
}

function handleUpload(n, input) {
  if (!input.files || !input.files[0]) return;
  var file = input.files[0];
  var reader = new FileReader();
  reader.onload = function(e) {
    var img = document.getElementById('img' + n);
    img.src = e.target.result;
    document.getElementById('preview' + n).style.display = 'block';
    document.getElementById('drop' + n).style.display = 'none';
    document.getElementById('name' + n).textContent = file.name;
    var card = document.getElementById('card' + n);
    card.classList.add('complete');
    var badge = document.getElementById('badge' + n);
    badge.textContent = 'Done';
    badge.className = 'upload-card-badge badge-done';
    uploaded[n - 1] = true;
    updateProgress();
  };
  reader.readAsDataURL(file);
}

function updateProgress() {
  var s0 = document.getElementById('step0');
  var s1 = document.getElementById('step1');
  var s2 = document.getElementById('step2');
  var btn = document.getElementById('generateBtn');

  if (countrySelected) s0.className = 'step-bar complete';
  if (uploaded[0]) s1.className = 'step-bar complete';
  if (uploaded[1]) s2.className = 'step-bar complete';

  // Enable generate if country + at least image 1
  btn.disabled = !(countrySelected && uploaded[0]);

  if (countrySelected && uploaded[0] && uploaded[1]) {
    s0.className = 'step-bar active';
    s1.className = 'step-bar active';
    s2.className = 'step-bar active';
  }
}

function generateReport() {
  var countryName = selectedCountryName || 'your region';

  document.getElementById('loadingOverlay').classList.add('visible');
  document.getElementById('step3').className = 'step-bar active';

  document.querySelector('.loading-sub').textContent =
    'Analysing vehicle listing Â· Checking ' + countryName + ' recalls & regulations';

  setTimeout(function() {
    document.getElementById('loadingOverlay').classList.remove('visible');
    var output = document.getElementById('reportOutput');
    output.classList.add('visible');

    document.getElementById('reportContent').innerHTML = '<div class="report">' +
      '<div class="report-header"><div class="report-icon">ğŸ”</div><div class="report-meta"><h3>Analysis Complete</h3><p>Vehicle Â· ' + countryName + ' Â· Based on ' + (uploaded[1] ? '2 screenshots' : '1 screenshot') + ' Â· Generated just now</p></div></div>' +
      '<div class="intel-block"><h4><span class="badge badge--critical">Critical</span> Issues Found</h4>' +
      '<ul class="intel-list">' +
      '<li><span><strong>Your full report would appear here.</strong> In production, this is generated from analysis of your uploaded screenshots.</span></li>' +
      '<li><span><strong>Vehicle-specific analysis</strong> tailored to ' + countryName + ' including local recalls, consumer protection laws, and market pricing.</span></li>' +
      '</ul></div>' +
      '<div class="report-verdict">This is a preview of the report layout. The real version includes safety recalls, hidden costs, mechanical issues, questions to ask, and a fair value estimate for ' + countryName + '.</div>' +
      '</div>';

    output.scrollIntoView({ behavior: 'smooth', block: 'start' });

    document.querySelector('.country-card').style.display = 'none';
    document.querySelector('.upload-cards').style.display = 'none';
    document.querySelector('.generate-section').style.display = 'none';
  }, 3000);
}
</script>
</body>
</html>
